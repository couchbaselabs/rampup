#!/bin/sh

set -e

echo "runtest TEST_NAME couchbase*.rpm NUM_ITEMS MEMBASE_NUM_VBUCKETS [JOIN_URL] [EXTRA_SLEEP]"
echo "runtest $1 $2 $3 $4 $5 $6"

mkdir -p out

echo "# start - runtest $1" > out/$1
date +%Y%m%d-%H%M%S >> out/$1

killall -9 memcached || true

/etc/init.d/couchbase-server stop || true

rpm -e couchbase-server || true
rm -rf /opt/couchbase/
rpm -i $2
sleep 5 $6

rm -f after-install

wget https://raw.github.com/couchbaselabs/rampup/master/after-install

./after-install $4

if test "$5" != ""; then
  /opt/couchbase/bin/membase rebalance -c $5 \
    -u Administrator -p password \
    --server-add=`/sbin/ifconfig eth0|grep inet|awk {'print $2'}|cut -d":" -f2|head -n 1`
else
  /opt/couchbase/bin/membase cluster-init -c 127.0.0.1 \
    --cluster-init-username=Administrator \
    --cluster-init-password=password
  /opt/couchbase/bin/membase bucket-create -c 127.0.0.1 \
    -u Administrator -p password \
    --bucket=default --bucket-type=membase --bucket-password= \
    --bucket-ramsize=6440 --bucket-replica=0
fi
sleep 5 $6

curl -vX PUT http://127.0.0.1:5984/default/_design/rampup -d @rampup.json

echo "# loading membase..." >> out/$1
date +%Y%m%d-%H%M%S >> out/$1

top -u couchbase | egrep beam.smp > /tmp/top.out &

DRIVE_HOST=127.0.0.1 RATIO_SETS=1.0 RATIO_CREATES=1.0 MAX_CREATES=$3 EXIT_AFTER_CREATES=1 \
  /opt/couchbase/bin/erl -pa . /opt/couchbase/lib/ns_server/erlang/lib/ns_server-*/ebin \
  -eval 'rampup:drive_test(), init:stop().'

killall top
tail -n 50 /tmp/top.out | head -n 10 >> out/$1

echo "# using membase..." >> out/$1
date +%Y%m%d-%H%M%S >> out/$1

top -u couchbase | egrep beam.smp > /tmp/top.out &

DRIVE_HOST=127.0.0.1 RATIO_SETS=0.0 MAX_OPS=10000 \
  /opt/couchbase/bin/erl -pa . /opt/couchbase/lib/ns_server/erlang/lib/ns_server-*/ebin \
  -eval 'rampup:drive_test(), init:stop().'

killall top
tail -n 50 /tmp/top.out | head -n 10 >> out/$1

echo "# view building..." >> out/$1
date +%Y%m%d-%H%M%S >> out/$1

top -u couchbase | egrep beam.smp > /tmp/top.out &

/usr/bin/time -a -o out/$1 curl -v "http://127.0.0.1:5984/default/_design/rampup/_view/random?limit=10"

killall top
tail -n 50 /tmp/top.out | head -n 10 >> out/$1

echo "# view accessing..." >> out/$1
date +%Y%m%d-%H%M%S >> out/$1

top -u couchbase | egrep beam.smp > /tmp/top.out &

./rampup-view.rb 127.0.0.1 10000 >> out/$1

killall top
tail -n 50 /tmp/top.out | head -n 10 >> out/$1

echo "# done - runtest $1" >> out/$1
date +%Y%m%d-%H%M%S >> out/$1
